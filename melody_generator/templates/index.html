<!doctype html>
<!--
  Melody Generator web form
  -------------------------
  This template renders the Flask front-end for configuring melody generation.
  It expects the following context variables:
    * ``scale`` – list of supported keys displayed in the key selector.
    * ``instruments`` – iterable of instrument names.
    * ``styles`` – iterable of named style embeddings.
    * ``form_values`` – dictionary containing the user's previous selections.
    * ``error_fields`` – set of field names that failed validation.

  Example usage:

      return render_template(
          "index.html",
          scale=["C", "G"],
          instruments=["Piano"],
          styles=["retro"],
          form_values={"key": "C"},
          error_fields={"key"},
      )

  The layout organises related controls into sections, surfaces helpful hints
  for each parameter, and highlights invalid inputs with accessible ARIA
  attributes so keyboard and screen-reader users can quickly recover from
  mistakes.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Melody Generator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="app-body">
  <div class="app-container">
    <header class="page-header">
      <h1 class="page-title">Generate Melody</h1>
      <p class="page-subtitle">
        Choose a musical key, progression and performance options, then render a MIDI preview
        you can download or play instantly.
      </p>
    </header>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-list" role="alert">
        {% for msg in messages %}
          <li class="flash-item">{{ msg }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form method="post" class="generator-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <section class="form-section">
        <h2 class="section-title">Core Settings</h2>
        <div class="form-grid">
          <label class="field">
            <span class="field-label">Key</span>
            <select
              name="key"
              class="field-control{% if 'key' in error_fields %} input-error{% endif %}"
              {% if 'key' in error_fields %}aria-invalid="true"{% endif %}
            >
              {% for k in scale %}
                <option value="{{ k }}" {% if form_values.key == k %}selected{% endif %}>{{ k }}</option>
              {% endfor %}
            </select>
            <span class="field-help">Major, minor and modal scales are supported.</span>
          </label>

          <label class="field">
            <span class="field-label">Chord progression</span>
            <input
              name="chords"
              class="field-control{% if 'chords' in error_fields %} input-error{% endif %}"
              value="{{ form_values.chords }}"
              placeholder="C,Am,F,G"
              {% if 'chords' in error_fields %}aria-invalid="true"{% endif %}
            >
            <span class="field-help">Comma-separated list. Leave blank to randomise.</span>
            <label class="checkbox-inline">
              <input type="checkbox" name="random_chords" value="1" {% if form_values.random_chords %}checked{% endif %}>
              Surprise me with a new progression
            </label>
          </label>

          <label class="field">
            <span class="field-label">Tempo (BPM)</span>
            <input
              type="number"
              name="bpm"
              min="1"
              class="field-control{% if 'bpm' in error_fields %} input-error{% endif %}"
              value="{{ form_values.bpm }}"
              {% if 'bpm' in error_fields %}aria-invalid="true"{% endif %}
            >
            <span class="field-help">Set the performance speed.</span>
          </label>

          <label class="field">
            <span class="field-label">Time signature</span>
            <input
              name="timesig"
              class="field-control{% if 'timesig' in error_fields %} input-error{% endif %}"
              value="{{ form_values.timesig }}"
              placeholder="4/4"
              {% if 'timesig' in error_fields %}aria-invalid="true"{% endif %}
            >
            <span class="field-help">Use numerator/denominator format such as 3/4.</span>
          </label>

          <label class="field">
            <span class="field-label">Melody length (notes)</span>
            <input
              type="number"
              name="notes"
              min="1"
              class="field-control{% if 'notes' in error_fields %} input-error{% endif %}"
              value="{{ form_values.notes }}"
              {% if 'notes' in error_fields %}aria-invalid="true"{% endif %}
            >
            <span class="field-help">Determines the number of generated pitches.</span>
          </label>

          <label class="field">
            <span class="field-label">Base octave</span>
            <input
              type="number"
              name="base_octave"
              class="field-control{% if 'base_octave' in error_fields %} input-error{% endif %}"
              value="{{ form_values.base_octave }}"
              {% if 'base_octave' in error_fields %}aria-invalid="true"{% endif %}
            >
            <span class="field-help">Controls the register for the main melody.</span>
          </label>

          <label class="field">
            <span class="field-label">Instrument</span>
            <select
              name="instrument"
              class="field-control{% if 'instrument' in error_fields %} input-error{% endif %}"
              {% if 'instrument' in error_fields %}aria-invalid="true"{% endif %}
            >
              {% for name in instruments %}
                <option value="{{ name }}" {% if form_values.instrument == name %}selected{% endif %}>{{ name }}</option>
              {% endfor %}
            </select>
            <span class="field-help">Mapped to General MIDI program numbers.</span>
          </label>

          <label class="field">
            <span class="field-label">Motif length</span>
            <input
              type="number"
              name="motif_length"
              min="1"
              class="field-control{% if 'motif_length' in error_fields %} input-error{% endif %}"
              value="{{ form_values.motif_length }}"
              {% if 'motif_length' in error_fields %}aria-invalid="true"{% endif %}
            >
            <span class="field-help">Initial motif size; repeated motifs are varied automatically.</span>
          </label>
        </div>
      </section>

      <section class="form-section">
        <h2 class="section-title">Arrangement</h2>
        <div class="checkbox-grid">
          <label class="checkbox-item">
            <input type="checkbox" name="harmony" value="1" {% if form_values.harmony %}checked{% endif %}>
            Add harmony line
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="counterpoint" value="1" {% if form_values.counterpoint %}checked{% endif %}>
            Include counterpoint
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="plagal_cadence" value="1" {% if form_values.plagal_cadence %}checked{% endif %}>
            Plagal cadence (IV–I ending)
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="include_chords" value="1" {% if form_values.include_chords %}checked{% endif %}>
            Export chord track
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="chords_same" value="1" {% if form_values.chords_same %}checked{% endif %}>
            Merge chords with melody
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="ornaments" value="1" {% if form_values.ornaments %}checked{% endif %}>
            Ornament markers
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="humanize" value="1" {% if form_values.humanize %}checked{% endif %}>
            Humanise performance
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="random_rhythm" value="1" {% if form_values.random_rhythm %}checked{% endif %}>
            Random rhythm pattern
          </label>
        </div>
        <label class="field harmony-lines">
          <span class="field-label">Harmony lines</span>
          <input
            type="number"
            name="harmony_lines"
            min="0"
            class="field-control{% if 'harmony_lines' in error_fields %} input-error{% endif %}"
            value="{{ form_values.harmony_lines }}"
            {% if 'harmony_lines' in error_fields %}aria-invalid="true"{% endif %}
          >
          <span class="field-help">Number of additional harmony voices (0 for monophonic output).</span>
        </label>
      </section>

      <section class="form-section">
        <h2 class="section-title">Style &amp; Machine Learning</h2>
        <div class="checkbox-item{% if 'enable_ml' in error_fields %} checkbox-error{% endif %}">
          <label>
            <input type="checkbox" name="enable_ml" value="1" {% if form_values.enable_ml %}checked{% endif %}>
            Use ML weighting for note selection (requires optional dependencies)
          </label>
        </div>
        <label class="field">
          <span class="field-label">Style preset</span>
          <select
            name="style"
            class="field-control{% if 'style' in error_fields %} input-error{% endif %}"
            {% if 'style' in error_fields %}aria-invalid="true"{% endif %}
          >
            <option value="" {% if not form_values.style %}selected{% endif %}></option>
            {% for name in styles %}
              <option value="{{ name }}" {% if form_values.style == name %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
          <span class="field-help">Select a documented embedding from README_STYLE_WEIGHTS.md.</span>
        </label>
      </section>

      <div class="form-actions">
        <button type="submit" class="primary-button">Generate Preview</button>
      </div>
    </form>
  </div>
</body>
</html>
